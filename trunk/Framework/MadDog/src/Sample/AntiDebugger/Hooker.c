#include "Hooker.h"
#include <string.h>

PVOID GetKeDispatchExceptionAddr()
{
	BYTE 	KDEFuncSignature[105] = {
		0x89, 0x45, 0xe4, 0x8b, 0x75, 0x08, 0x89, 0xb5,
		0x14, 0xfd, 0xff, 0xff, 0x8b, 0x4d, 0x0c,0x89,
		0x8d, 0x10, 0xfd, 0xff, 0xff, 0x8b, 0x5d, 0x10,
		0x89, 0x9d, 0x08, 0xfd, 0xff, 0xff, 0x64, 0xa1,
		0x20, 0x00, 0x00, 0x00, 0xff, 0x80, 0x04, 0x05,
		0x00, 0x00, 0xc7, 0x85, 0x18, 0xfd, 0xff, 0xff,
		0x17, 0x00, 0x01, 0x00, 0x80, 0x7d, 0x14, 0x01,
		0x74, 0x09, 0x80, 0x3d, 0x41, 0xba, 0x55, 0x80,
		0x00, 0x74, 0x1d, 0xc7, 0x85, 0x18, 0xfd, 0xff,
		0xff, 0x1f, 0x00, 0x01, 0x00, 0x80, 0x3d, 0x80,
		0x21, 0x56, 0x80, 0x00, 0x74, 0x0a, 0xc7, 0x85,
		0x18, 0xfd, 0xff, 0xff, 0x3f, 0x00, 0x01, 0x00,
		0x8d, 0x85, 0x18, 0xfd, 0xff, 0xff, 0x50, 0x51,
		0x53,
	};
	char* p;

	p=strstr((char*)(0x80000000),(char*)KDEFuncSignature);
	if(p)
	{
		DbgPrint("Found!");
		if( *(p-20) == '0x68')
			return (PVOID)(p-20);
	}

	return 0;

	
}
PVOID GetKernelBase()
{
	PSYSTEM_MODULE_INFORMATION_EX	info;
	NTSTATUS						status;
	ULONG							req_len;
	PVOID							base;

	info = NULL; base = NULL;
	do
	{
		status = ZwQuerySystemInformation(
			SystemModuleInformation, NULL, 0, &req_len
			);

		if (status != STATUS_INFO_LENGTH_MISMATCH) {
			break;
		}

		if ( (info = ExAllocatePoolWithTag (NonPagedPool, BYTES_TO_PAGES(req_len),'ITL')) == NULL ) {
			break;
		}
		/*if ( (info = mem_alloc(req_len)) == NULL ) {
			break;
		}*/

		status = ZwQuerySystemInformation(
			SystemModuleInformation, info, req_len, NULL
			);

		if (NT_SUCCESS(status) == FALSE) {
			break;
		}

		base = info->Modules[0].Base;
	} while (0);

	if (info != NULL) {
		ExFreePool(info);
	}

	return base;
}